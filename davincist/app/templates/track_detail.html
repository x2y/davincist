{% extends "base_track.html" %}

{% load tags %}

{% block tab_title %}{{ track.name|capfirst }}{% endblock %}
{% block subtitle %}Home{% endblock %}

{% block head %}
{{ block.super }}
<script>var trackName = '{{ track.name|escapejs }}';</script>
<style>
  #nav #track-home-link {
    color: #FAFAFA;
    border-color: #FAFAFA;
  }
</style>
{% endblock %}


{% block content %}
{{ track.description }}
<p>{{ track.mission }}
<p><img src="/media/{{ track.crest }}" width="100px" height="100px"></img>

{% if user.is_authenticated and not user_track %}
  <p>
    <button id="join-track-button">Join {{ track.name }}!</button>
    <div id="join-track-error" class="error"></div>
  </p>
{% endif %}

<h2> Announcements </h2>
<p> Announcements go here </p>
<h3>Levels</h3>
<ul>
{% for level in track.levels.all %}
  <li>
    {{ level.user_count }}
    {% if level.user_count == 1 %}user is{% else %}users are{% endif %} on {{ level.name}}
    <ul>
    {% for requirement in level.requirements.all %}
      <li>
        {% for badge in requirement.badges.all %}
          {% badge_link badge %}
          {% if not forloop.last %} or {% endif %}
        {% endfor %}
      </li>
    {% endfor %}
    </ul>
  </li>
{% endfor %}
</ul>
{% endblock %}

{% block footer_script %}
{{ block.super }}
<script>
  {% if user.is_authenticated and not user_track %}
    $(function() {
      $('#join-track-button').click(joinTrack);
    });

    <!-- TODO: Refactor into a common location so that it can be utilized in multiple locations. -->
    function joinTrack() {
      $('#join-track-button').attr('disabled', true);
      $('#join-track-error').text('');

      var data = {};
      data.track = trackName;
      $.post('{% url ajax_join_track %}', data, function (data) {
        if (data.errors) {
          $('#join-track-error').text(data.errors.join());
          return;
        }
        location.reload();
      }).fail(function() {
        $('#join-track-error').text('Server error!');
      }).always(function() {
        $('#join-track-button').removeAttr('disabled');
      });
    }
  {% endif %}
</script>
{% endblock %}