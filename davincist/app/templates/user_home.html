{% extends "base_user.html" %}

{% load tags %}

{% block tab_title %}{{ target_user.username }}'s Profile{% endblock %}

{% block head %}
{{ block.super }}
<script>var targetUserPk = {{ target_user.pk }};</script>
{% endblock %}

{% block content %}
<h2>Notifications</h2>
TODO
<h2>Current challenges</h2>
<ul>
{% for user_track in target_user.user_tracks.all %}
  {% with current_challenges=user_track.current_challenges %}
    {% if current_challenges %}
      <li>{{ user_track.track.name }}
      <ul>
      {% for verification in current_challenges %}
        <li>{{ verification }}
      {% endfor %}
      </ul>
    {% else %}
      <li>No challenges in progress for {{ user_track.track.name }}!
    {% endif %}
  {% endwith %}
{% endfor %}
</ul>
<h2>Upcoming challenges</h2>
<ul>
{% for user_track in target_user.user_tracks.all %}
  {% with next_requirements=user_track.next_requirements %}
    {% if next_requirements %}
      <li>{{ user_track.track.name }}
      <ul>
      {% for requirement in next_requirements %}
        <li>{{ requirement }}
      {% endfor %}
      </ul>
    {% else %}
      <li>No unstarted requirements for {{ user_track.track.name }}!
    {% endif %}
  {% endwith %}
{% endfor %}
</ul>
<h2>Challenges to verify</h2>
<ul>
{% for user_track in target_user.user_tracks.all %}
  {% with challenges_to_verify=user_track.challenges_to_verify %}
    {% if challenges_to_verify %}
      <li>{{ user_track.track.name }}
      <ul>
      {% for verification in challenges_to_verify %}
        <li>{{ verification }}
      {% endfor %}
      </ul>
    {% else %}
      <li>No challenges to verify for {{ user_track.track.name }}!
    {% endif %}
  {% endwith %}
{% endfor %}
</ul>

<!-- Begin wall code. -->
<h2>Your wall</h2>

<!-- Move the wall posting stuff into a reusable template. -->
<div id="wall-post-box">
  <textarea id="wall-post-textbox"></textarea>
  <div id="wall-post-error" class="error"></div>
  <div id="wall-post-button-box">
    <button id="wall-post-public-button">Post Public</button>
    <button id="wall-post-private-button">Post Private</button>
  </div>
</div>

{% include "wall_template.html" %}
<div id="wall-load-previous-error" class="error"></div>
<button id="wall-load-previous-button" disabled>Load more</button>
{% endblock %}

{% block footer_script %}
{{ block.super }}
<script>
  var earliestWallPostPk = null;

  $(function () {
    $('#wall-load-previous-button').click(loadPreviousWallPosts);
    $('#wall-post-public-button').click(function() { postToWall(true); });
    $('#wall-post-private-button').click(function() { postToWall(false); });

    loadPreviousWallPosts();
  });

  function loadPreviousWallPosts() {
    $('#wall-load-previous-button').attr('disabled', true);
    $('#wall-load-previous-error').text('');

    var data = {};
    data.target_user = targetUserPk;
    if (earliestWallPostPk) {
      data.since_pk = earliestWallPostPk;
    }
    $.ajax({
      url: '{% url ajax_get_wall_posts %}',
      data: data,
      cache: false,
      success: function (data) {
        if (data.errors) {
          $('#wall-load-previous-posts-error').text(data.errors.join());
          return;
        }
        for (var i = 0; i < data.wall_posts.length; ++i) {
          var post = data.wall_posts[i];
          post.timestamp = new Date(post.timestamp * 1000).toLocaleString();

          var postClass = post.is_public ? '.public-post' : '.private-post';
          renderTemplate($(postClass + '.template'), post).appendTo($('#wall'));
          earliestWallPostPk = post.pk;
        }
        if (!data.has_next) {
          $('#wall-load-previous-button').remove();
        }
      }
    }).fail(function() {
      $('#wall-load-previous-error').text('Server error!');
    }).always(function() {
      $('#wall-load-previous-button').removeAttr('disabled');
    });
  }

  function postToWall(is_public) {
    $('#wall-post-box :input').attr('disabled', true);
    $('#wall-post-error').text('');

    var data = {};
    data.text = $('#wall-post-textbox').val();
    data.to = targetUserPk;
    data.is_public = is_public;
    $.post('{% url ajax_post_to_wall %}', data, function (data) {
      if (data.errors) {
        $('#wall-post-error').text(data.errors.join());
        return;
      }

      data.post.timestamp = new Date(data.post.timestamp * 1000).toLocaleString();
      var postClass = data.post.is_public ? '.public-post' : '.private-post';
      renderTemplate($(postClass + '.template'), data.post).prependTo($('#wall'));
      $('#wall-post-textbox').val('');
    }).fail(function() {
      $('#wall-post-error').text('Server error!');
    }).always(function() {
      $('#wall-post-box :input').removeAttr('disabled');
    });
  }
</script>
{% endblock %}
