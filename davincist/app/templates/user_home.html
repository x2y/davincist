{% extends "base_user.html" %}

{% load tags %}

{% block tab_title %}{{ target_user.username }}'s Profile{% endblock %}

{% block head %}
{{ block.super }}
<script>var targetUserPk = {{ target_user.pk }};</script>
{% endblock %}

{% block content %}

{% comment %}Temporary styling to show how public/private classes work{% endcomment %}
<style type="text/css">
.public {color:black;}
.private {color:blue;}
</style>

{% comment %}<img src="{{ target_user.profile.profile_image }}" height=200 width=200>{% endcomment %}
--PROFILE PICTURE HERE--<br>
{{ target_user.username }} Overall XP: {{ target_user.profile.xp }}<br>
<br>
{{ target_user.username }} is a member of the following tracks:<br>
{% for user_track in target_user.user_tracks.all %}
  {% track_link user_track.track %}<br>
  {% if user_track.mission %}Her/His/Its Mission: {{ user_track.mission }}<br>{% endif %}
  {{ user_track.track.name }} Level: {{ user_track.level.rank }}: {{ user_track.level.name }} ({{ user_track.xp }} XP)<br>
  Top badges: 
  {% for top_badge in user_track.top_badges %}
    {% badge_link top_badge %}{% if not forloop.last %},&nbsp;{% endif %}
  {% empty %}
    No badges acquired in this track yet.
  {% endfor %}
  <br><br>  
{% empty %}
  He/She/It hasn't joined any tracks yet!
{% endfor %}

<!-- Begin wall code. -->
<h2>Your Wall</h2>

<!-- Move the wall posting stuff into a reusable template. -->
<div id="wall-post-box">
  <textarea id="wall-post-textbox"></textarea>
  <div id="wall-post-error" class="error"></div>
  <div id="wall-post-button-box">
    <button id="wall-post-public-button">Post Public</button>
    <button id="wall-post-private-button">Post Private</button>
  </div>
</div>

<div id="wall"></div>
<div id="wall-load-previous-error" class="error"></div>
<button id="wall-load-previous-button" disabled>Load more</button>
{% endblock %}

{% block footer_script %}
{{ block.super }}
<script>
  var earliestWallPostPk = null;

  $(function () {
    $('#wall-load-previous-button').click(loadPreviousWallPosts);
    $('#wall-post-public-button').click(function() { postToWall(true); });
    $('#wall-post-private-button').click(function() { postToWall(false); });

    loadPreviousWallPosts();
  });

  function renderWallPost(data) {
    var $newPost = $('<div class="wall-post"></div>');
    if (!data.is_public) {
      $newPost.addClass('private');
    }
    $newPost.append($('<span class="poster">').text(data.poster));
    $newPost.append($('<span>').text(data.text));
    $newPost.append($('<span class="timestamp">').text(
        new Date(data.timestamp * 1000).toLocaleString()));
    return $newPost;
  }

  function loadPreviousWallPosts() {
    $('#wall-load-previous-button').attr('disabled', true);
    $('#wall-load-previous-error').text('');

    var data = {};
    data.target_user = targetUserPk;
    if (earliestWallPostPk) {
      data.since_pk = earliestWallPostPk;
    }
    $.ajax({
      url: '{% url ajax_get_wall_posts %}',
      data: data,
      cache: false,
      success: function (data) {
        if (data.errors) {
          $('#wall-load-previous-posts-error').text(data.errors.join());
          return;
        }
        for (var i = 0; i < data.wall_posts.length; ++i) {
          var post = data.wall_posts[i];
          renderWallPost(post).appendTo($('#wall'));
          earliestWallPostPk = post.pk;
        }
        if (!data.has_next) {
          $('#wall-load-previous-button').remove();
        }
      }
    }).fail(function() {
      $('#wall-load-previous-error').text('Server error!');
    }).always(function() {
      $('#wall-load-previous-button').removeAttr('disabled');
    });
  }

  function postToWall(is_public) {
    $('#wall-post-box :input').attr('disabled', true);
    $('#wall-post-error').text('');

    var data = {};
    data.text = $('#wall-post-textbox').val();
    data.to = targetUserPk;
    data.is_public = is_public;
    $.post('{% url ajax_post_to_wall %}', data, function (data) {
      if (data.errors) {
        $('#wall-post-error').text(data.errors.join());
        return;
      }

      renderWallPost(data.post).prependTo($('#wall'));
      $('#wall-post-textbox').val('');
    }).fail(function() {
      $('#wall-post-error').text('Server error!');
    }).always(function() {
      $('#wall-post-box :input').removeAttr('disabled');
    });
  }
</script>
{% endblock %}
