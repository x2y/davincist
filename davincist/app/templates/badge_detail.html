{% extends "base_track.html" %}

{% load tags %}

{% block title %}{{ track.name|capfirst }} - {{ badge.name|capfirst }}{% endblock %}

{% block head %}
{{ block.super }}
<script>var badgePk = {{ badge.pk }};</script>
{% endblock %}

{% block gutter_subtitle %}Badge{% endblock %}

{% block content %}
<h1>Lvl {{ badge.requirement.level.rank }} - {{ badge.name }}</h1>
<p>
<h2>{{ badge.description }}</h2>
<p>
<div id="training">
  {{ badge.training|safe }}
  {% if not badge_status %}
    <div id="start-badge-mask">
      <div>
        <!-- TODO: Change to a "Join this track" button if not already joined. -->
        <!-- TODO: Change to a login/join link if not logged in. -->
        <button id="start-badge-button">Start {{ badge.name }}!</button>
        <div id="start-badge-error"></div>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block footer_script %}
{{ block.super }}
<script>
  $(function() {
    {% if not badge_status %}
      $('#start-badge-button').click(startBadge);
    {% else %}
      $('#training').css('max-height', 'none');
    {% endif %}
  });

  {% if not badge_status %}
    function startBadge() {
      $('#start-badge-button').attr('disabled', true);

      var data = {};
      data.badge = badgePk;
      $.post('{% url ajax_start_badge %}', data, function (data) {
        if (data.errors) {
          $('#start-badge-error').text(data.errors.join());
          return;
        }
        $('#start-badge-mask').remove();
        $('#training').css('max-height', 'none');
      }).fail(function() {
        $('#start-badge-error').text('Server error!');
      }).always(function() {
        $('#start-badge-button').removeAttr('disabled');
      });
    }
  {% endif %}
</script>
{% endblock %}
